

-- ==========================  USERS  =====================--

DROP DATABASE IF EXISTS USER_SRVC;
DROP USER IF EXISTS 'USER_SRVC_TEST'@'localhost';

CREATE USER 'USER_SRVC_TEST'@'localhost' IDENTIFIED BY 'iabus9bie9eeZ8wein2ohfaequien';

SYSTEM mysql -u USER_SRVC_TEST -piabus9bie9eeZ8wein2ohfaequien

CREATE DATABASE USER_SRVC;

GRANT ALL PRIVILEGES ON USER_SRVC.* TO 'USER_SRVC_TEST'@'localhost';

USE USER_SRVC;

-- ==========================  SEQUENCES  =====================--

-- CALL CreateSequence('USER_ID_SEQ', 1050, 1);
-- CALL CreateSequence('REMARK_ID_SEQ', 1250, 1);
-- CALL CreateSequence('PHOTO_ID_SEQ', 13350, 1);

-- ==========================  TABLES  =====================--

CREATE TABLE STR_POOL (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  VALUE VARCHAR(128)
);

CREATE TABLE UUSER_ABS (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  FULLNAME VARCHAR(64),
  EMAIL VARCHAR(128) UNIQUE,
  TOKEN VARCHAR(64),
  HOST VARCHAR(128),
  PASSWORD VARCHAR(128) DEFAULT '$2a$10$3NTPya6TN.11/VLxBhJjBekgWOmV.Y.OvvQOjy9y07hiNEKjQPp5S',
  PERMISSION_ID BIGINT(16) DEFAULT 1,
  DTYPE VARCHAR(8) DEFAULT 'UUser'
);

CREATE TABLE PERMISSION (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  USER_ID BIGINT(16),
  APP_USER_ID BIGINT(16),
  REF_TYPE VARCHAR(32),
  REF_ID BIGINT(16),
  TYPE VARCHAR(32),
  ORIGIN_USER_ID BIGINT(16),
  GRANTED_FROM_USER_ID BIGINT(16),
  CONSTRAINT FK_PERMISSION_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT FK_PERMISSION_ORIGIN FOREIGN KEY (ORIGIN_USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT FK_PERMISSION_GRANTED FOREIGN KEY (GRANTED_FROM_USER_ID) REFERENCES UUSER_ABS(ID)
);

CREATE TABLE USER_PHOTO (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  USER_ID BIGINT(16),
  APP_USER_ID BIGINT(16),
  POSITION TINYINT,
  URL VARCHAR(256),
  CONSTRAINT FK_USER_PHOTO FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID)
);


CREATE TABLE REMARK(
  ID BIGINT(16) PRIMARY KEY,
  POSTER_ID BIGINT(16),
  CONVERSATION_ID BIGINT(16),
  CONTENT LONGTEXT,
  TIME_STAMP DATETIME(6),
  CONSTRAINT FK_POSTER_REMARK FOREIGN KEY (POSTER_ID) REFERENCES UUSER_ABS(ID)
);

CREATE TABLE HAS_READ(
  REMARK_ID BIGINT(16),
  USER_ID BIGINT(16),
  CONSTRAINT FK_REMARK_HAS_READ FOREIGN KEY (REMARK_ID) REFERENCES REMARK(ID),
  CONSTRAINT FK_USER_HAS_READ FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT COMP_PK_HAS_READ PRIMARY KEY (REMARK_ID, USER_ID)
);

CREATE TABLE COLLAPSE_USER(
  FOR_USER_ID BIGINT(16),
  TARGET_USER_ID BIGINT(16),
  CONSTRAINT FK_FOR_USER FOREIGN KEY (FOR_USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT FK_TARGET_USER FOREIGN KEY (TARGET_USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT COMP_PK_COLLAPSE_USER PRIMARY KEY (FOR_USER_ID, TARGET_USER_ID)
);

CREATE TABLE APP (
  ID BIGINT(16) PRIMARY KEY,
  ACCESS_KEY VARCHAR(64),
  NAME VARCHAR(64),
  HOST VARCHAR(128),
  PROTECTED_APP_ID VARCHAR(64) NULL,
  TOKEN_EXPIRATION BIGINT(16) DEFAULT 999999999999999
);

-- ==========================  ACCESS  =====================--
-- ==========================  AUTHORIZE  =====================--

CREATE TABLE AUTHORIZED_APP_USER (
  APP_ID BIGINT(16),
  USER_ID BIGINT(16),
  CONSTRAINT COMP_PK_AUTH_APP_USERS PRIMARY KEY (APP_ID, USER_ID),
  CONSTRAINT FK_AUTH_APP_USER_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT FK_AUTH_APP_USER_APP FOREIGN KEY (APP_ID) REFERENCES APP(ID)
);

CREATE TABLE ACCESS_TOKEN (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  OBJECT_ID BIGINT(16),
  TOKEN VARCHAR(64),
  DTYPE VARCHAR(32),
  EXPIRATION BIGINT(16) NOT NULL,
  DEVICE_IDENTIFIER VARCHAR(64) NOT NULL
);

CREATE TABLE USER_TOKEN (
  USER_ID BIGINT(16),
  DTYPE VARCHAR(32),
  TOKEN VARCHAR(64),
  DEVICE_IDENTIFIER VARCHAR(64) NOT NULL,
  EXPIRATION BIGINT(16) NOT NULL,
  CONSTRAINT COMP_PK_USER_TOKEN PRIMARY KEY (USER_ID, DEVICE_IDENTIFIER, DTYPE)
);

CREATE TABLE RULE (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  APP_ID BIGINT(16),
  APP_EXCLUSION INT(1) DEFAULT 1,
  USER_EXCLUSION INT(1) DEFAULT 1,
  ENDPOINT_REG_EXP VARCHAR(128),
  CONSTRAINT FK_GATE_APP FOREIGN KEY (APP_ID) REFERENCES APP(ID)
);

CREATE TABLE USER_RULE (
  RULE_ID BIGINT(16),
  USER_ID BIGINT(16),
  CONSTRAINT COMP_PK_USER_RULE PRIMARY KEY (RULE_ID, USER_ID),
  CONSTRAINT FK_USER_RULE_RULE FOREIGN KEY (RULE_ID) REFERENCES RULE(ID),
  CONSTRAINT FK_USER_RULE_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID)
);

CREATE TABLE APP_RULE (
  RULE_ID BIGINT(16),
  APP_ID BIGINT(16),
  CONSTRAINT COMP_PK_USER_RULE PRIMARY KEY (RULE_ID, APP_ID),
  CONSTRAINT FK_APP_RULE_RULE FOREIGN KEY (RULE_ID) REFERENCES RULE(ID),
  CONSTRAINT FK_APP_RULE_APP FOREIGN KEY (APP_ID) REFERENCES APP(ID)
);

-- ==========================  ACCESS  =====================--

CREATE TABLE OBJECT (
  ID BIGINT(16) PRIMARY KEY,
  OBJECT_NAME_ID BIGINT(16),
  TARGET_USER_ID BIGINT(16),
  CONSTRAINT FK_OBJECT_USER FOREIGN KEY (TARGET_USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT FK_OBJECT_STR_POOL FOREIGN KEY (OBJECT_NAME_ID) REFERENCES STR_POOL(ID)
);

CREATE TABLE FIELDS (
  ID BIGINT(16) PRIMARY KEY,
  OBJECT_ID BIGINT(16),
  FIELD_NAME_ID BIGINT(16),
  CONSTRAINT FK_FIELDS_OBJECT FOREIGN KEY (OBJECT_ID) REFERENCES OBJECT(ID),
  CONSTRAINT FK_FIELDS_STR_POOL FOREIGN KEY (FIELD_NAME_ID) REFERENCES STR_POOL(ID)
);

CREATE TABLE USER_GROUP (
  ID BIGINT(16) PRIMARY KEY,
  NAME VARCHAR(32)
);

-- ==========================  APP_ACCESS  =====================--

CREATE TABLE APP_USER_GROUP (
  ID BIGINT(16) PRIMARY KEY,
  APP_ID BIGINT(16),
  GROUP_ID BIGINT(16),
  CONSTRAINT FK_APP_USER_GROUP_APP FOREIGN KEY (APP_ID) REFERENCES APP(ID),
  CONSTRAINT FK_APP_USER_GROUP_USER_GROUP FOREIGN KEY (GROUP_ID) REFERENCES USER_GROUP(ID)
);

CREATE TABLE APP_USER_GROUP_MEMEBERS (
    APP_USER_GROUP_ID BIGINT(16),
    USER_ID BIGINT(16),
    CONSTRAINT FK_APP_MEMBERS_APP_GROUP FOREIGN KEY (APP_USER_GROUP_ID) REFERENCES APP_USER_GROUP(ID),
    CONSTRAINT FK_APP_MEMBERS_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID)
);

CREATE TABLE APP_FIELD_ACCESS (
  ID BIGINT(16) PRIMARY KEY,
  APP_ID BIGINT(16),
  OBJECT_TYPE VARCHAR(128),
  OBJECT_ID BIGINT(16),
  FIELD_NAME VARCHAR(128),
  CONSTRAINT FK_FIELD_ACCESS_APP FOREIGN KEY (APP_ID) REFERENCES APP(ID)
);

-- ==========================  USER_ACCESS  =====================--

CREATE TABLE USER_FIELD_ACCESS (
  ID BIGINT(16) PRIMARY KEY,
  USER_ID BIGINT(16),
  TYPE INT(1),
  OBJECT_TYPE VARCHAR(128),
  OBJECT_ID BIGINT(16),
  FIELD_NAME VARCHAR(128),
  CONSTRAINT FK_FIELD_ACCESS_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID)
);

CREATE TABLE USER_FIELD_ACCESS_EXCEPTIONS (
  ID BIGINT(16) PRIMARY KEY,
  USER_ID BIGINT(16),
  OBJECT_ID VARCHAR(128),
  FIELD_NAME VARCHAR(128),
  CONSTRAINT FK_FIELD_ACCESS_EXP_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID)
);

CREATE TABLE USER_USER_GROUP (
  ID BIGINT(16) PRIMARY KEY,
  USER_ID BIGINT(16),
  GROUP_ID BIGINT(16),
  CONSTRAINT FK_USER_USER_GROUP_APP FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT FK_USER_USER_GROUP_USER_GROUP FOREIGN KEY (GROUP_ID) REFERENCES USER_GROUP(ID)
);

CREATE TABLE USER_USER_GROUP_MEMEBERS (
    USER_USER_GROUP_ID BIGINT(16),
    USER_ID BIGINT(16),
    CONSTRAINT FK_USER_MEMBERS_USER_GROUP FOREIGN KEY (USER_USER_GROUP_ID) REFERENCES USER_USER_GROUP(ID),
    CONSTRAINT FK_USER_MEMBERS_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID)
);

-- ==================== Reference Tables ============================ --

CREATE TABLE UUSER_SERVERS (
  HOST VARCHAR(128),
  USER_HITS BIGINT(16) DEFAULT 0,
  APP_HITS BIGINT(16) DEFAULT 0
);

CREATE TABLE UUSER_REFERENCES (
  USER_EMAIL VARCHAR(128),
  HOST VARCHAR(128)
);

CREATE TABLE APP_REFERENCE (
  APP_ID BIGINT(16),
  HOST VARCHAR(128)
);

-- ==================== Object Permission Tables ============================ --

CREATE TABLE SCOPE (
  ID INT(1) PRIMARY KEY,
  VALUE VARCHAR(16) UNIQUE
);

CREATE TABLE FIELD_NAME (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  VALUE VARCHAR(16) UNIQUE
);

CREATE TABLE OBJECT_NAME (
  ID BIGINT(16) PRIMARY KEY AUTO_INCREMENT,
  VALUE VARCHAR(16) UNIQUE
);

CREATE TABLE FIELD_SCOPE (
  USER_ID BIGINT(16),
  APP_ID BIGINT(16),
  OBJECT_NAME_ID BIGINT(16),
  FIELD_NAME_ID BIGINT(16),
  SCOPE_ID INT(1),
  CONSTRAINT COMP_PK_FIELD_SCOPE PRIMARY KEY (USER_ID, APP_ID, OBJECT_NAME_ID, FIELD_NAME_ID),
  CONSTRAINT FK_FIELD_SCOPE_USER FOREIGN KEY (USER_ID) REFERENCES UUSER_ABS(ID),
  CONSTRAINT FK_FIELD_SCOPE_APP FOREIGN KEY (APP_ID) REFERENCES APP(ID),
  CONSTRAINT FK_FIELD_SCOPE_OBJECT FOREIGN KEY (OBJECT_NAME_ID) REFERENCES OBJECT_NAME(ID),
  CONSTRAINT FK_FIELD_SCOPE_FIELD FOREIGN KEY (FIELD_NAME_ID) REFERENCES FIELD_NAME(ID),
  CONSTRAINT FK_FIELD_SCOPE_SCOPE FOREIGN KEY (SCOPE_ID) REFERENCES SCOPE(ID)
);

CREATE TABLE DEFAULT_SCOPE (
  OBJECT_NAME_ID BIGINT(16),
  FIELD_NAME_ID BIGINT(16),
  SCOPE_ID INT(1),
  CONSTRAINT COMP_PK_FIELD_SCOPE PRIMARY KEY (OBJECT_NAME_ID, FIELD_NAME_ID, SCOPE_ID),
  CONSTRAINT FK_DEFAULT_SCOPE_OBJECT FOREIGN KEY (OBJECT_NAME_ID) REFERENCES OBJECT_NAME(ID),
  CONSTRAINT FK_DEFAULT_SCOPE_FIELD FOREIGN KEY (FIELD_NAME_ID) REFERENCES FIELD_NAME(ID),
  CONSTRAINT FK_DEFAULT_SCOPE_SCOPE FOREIGN KEY (SCOPE_ID) REFERENCES SCOPE(ID)
);

CREATE OR REPLACE VIEW APP_FIELD_SCOPE AS
  SELECT FS.USER_ID, FS.APP_ID, FS.OBJECT_NAME_ID, FS.FIELD_NAME_ID,
      FIELD.VALUE AS FIELD, SCOPE.VALUE AS SCOPE,
      DS.VALUE AS DEFAULT_SCOPE
    FROM FIELD_SCOPE AS FS
    JOIN FIELD_NAME AS FIELD ON FIELD_NAME_ID = FIELD.ID
    JOIN SCOPE ON FS.SCOPE_ID = SCOPE.ID
    JOIN DEFAULT_SCOPE ON
      FS.OBJECT_NAME_ID = DEFAULT_SCOPE.OBJECT_NAME_ID AND
      FS.FIELD_NAME_ID = DEFAULT_SCOPE.FIELD_NAME_ID AND
      FS.SCOPE_ID = DEFAULT_SCOPE.SCOPE_ID
    JOIN SCOPE AS DS ON DS.ID = DEFAULT_SCOPE.SCOPE_ID;

-- ==========================  JUnit Test Data  =====================--
INSERT INTO UUSER_ABS (ID,FULLNAME,EMAIL,TOKEN) VALUES (-1,'ADMIN','jozsef.morrissey@yahoo.com','[B@d077e31');

INSERT INTO APP (ID, ACCESS_KEY, NAME) VALUES (1, 'sithiophixaequaoneinah1ooSh8Sh', 'USVC_SERVER');
INSERT INTO APP (ID, ACCESS_KEY, NAME) VALUES (-1, 'password', 'Defult_App');
INSERT INTO AUTHORIZED_APP_USER (APP_ID, USER_ID) VALUES (1, -1);

INSERT INTO RULE (ID, APP_ID, ENDPOINT_REG_EXP) VALUES (1, 1, ".*");

INSERT INTO UUSER_ABS (ID,FULLNAME,EMAIL,TOKEN) VALUES (1,'Jozsef Morrissey','jozsef.morrissey@gmail.com','[B@d077e31');
INSERT INTO UUSER_ABS (ID,FULLNAME,EMAIL,TOKEN) VALUES (2,'Jerad Morrissey','red3091@gmail.com','[B@d077e31');
INSERT INTO UUSER_ABS (ID,FULLNAME,EMAIL,TOKEN) VALUES (3,'Victor You Cant Handle This Quintanilla','vict.qp@gmail.com','[B@d077e31');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',4,'Calvin Singleton','gravida.mauris.ut@velitduisemper.org');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',5,'Haviva Hull','egestas.blandit@Ut.co.uk');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',6,'Amal Figueroa','In.faucibus@velfaucibus.ca');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',7,'Sade Reid','Pellentesque.ultricies.dignissim@ategestas.co.uk');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',8,'Jared Estrada','convallis.ligula.Donec@estarcuac.org');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',9,'Lana Abbott','posuere@enim.edu');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',10,'Edan Chavez','dapibus@in.net');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',11,'Fletcher Crosby','nunc.sed.libero@elementumlorem.net');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',12,'Adrian Goodman','dictum.Phasellus@consectetuermauris.org');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',13,'Sean Alston','Nam.porttitor.scelerisque@Utsagittislobortis.net');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',14,'Emerald Horn','nibh.enim.gravida@CuraeDonectincidunt.com');
INSERT INTO UUSER_ABS (TOKEN,ID,FULLNAME,EMAIL) VALUES ('[B@d077e31',15,'Reese Jimenez','pellentesque.a@duinec.ca');

INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (1,1,124,'This is the skill that never ends. ',STR_TO_DATE('10-SEP-0214:10:10','%d-%b-%y%T'));
INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (2,1,124,'It goes on and on my friends. ',STR_TO_DATE('10-SEP-0214:33:10','%d-%b-%y%T'));
INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (3,1,124,'some people started concatinating not knowing what it was ',STR_TO_DATE('10-SEP-0214:14:13','%d-%b-%y%T'));
INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (4,1,124,'and they just kept concatinating forever just because',STR_TO_DATE('10-SEP-0214:10:12','%d-%b-%y%T'));

INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (5,2,124,'In all seriousness ',STR_TO_DATE('10-SEP-0214:10:10','%d-%b-%y%T'));
INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (6,2,124,'I think this is a powerful tool that is worth the trouble. ',STR_TO_DATE('10-SEP-0214:10:14','%d-%b-%y%T'));
INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (7,2,124,'Now users can provide as much or as little information as they want. ',STR_TO_DATE('10-SEP-0214:16:10','%d-%b-%y%T'));
INSERT INTO REMARK (ID,POSTER_ID, CONVERSATION_ID, CONTENT, TIME_STAMP) VALUES (8,2,124,'Without harsh memory costs to the system... Enjoy!',STR_TO_DATE('10-SEP-0214:15:10','%d-%b-%y%T'));

INSERT INTO PERMISSION (ID, USER_ID, REF_TYPE, REF_ID, TYPE, ORIGIN_USER_ID) VALUES (-1, -1, '__admin__', -1, 'oao', null);
INSERT INTO PERMISSION (ID, USER_ID, REF_TYPE, REF_ID, TYPE, ORIGIN_USER_ID, APP_USER_ID) VALUES (1, 2, 'object', 3, 'oao', null,1);
INSERT INTO PERMISSION (ID, USER_ID, REF_TYPE, REF_ID, TYPE, ORIGIN_USER_ID, APP_USER_ID) VALUES (2, 4, 'object', 3, 'psuedo', null,1);
INSERT INTO PERMISSION (ID, USER_ID, REF_TYPE, REF_ID, TYPE, ORIGIN_USER_ID, APP_USER_ID) VALUES (3, 7, 'object', 3, 'validation', 4,1);
